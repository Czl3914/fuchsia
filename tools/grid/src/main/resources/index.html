<!--
  #%L
  OW2 Chameleon - Fuchsia Framework
  %%
  Copyright (C) 2009 - 2014 OW2 Chameleon
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
       http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
<html>
<head>

    <style>

        .link {
            fill: none;
            stroke: #666;
            stroke-width: 1.5px;
        }

        #licensing {
            fill: green;
        }

        .link.licensing {
            stroke: green;
        }

        .link.resolved {
            stroke-dasharray: 0,2 1;
        }

        circle {
            fill: #ccc;
            stroke: #333;
            stroke-width: 1.5px;
        }

        text {
            font: 10px sans-serif;
            pointer-events: none;
            text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff;
        }

    </style>

    <script src="http://d3js.org/d3.v2.min.js"></script>
    <script type='text/javascript' src='http://code.jquery.com/jquery-2.1.0.js'></script>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>

</head>
<body>

<!--
<svg width="1024" height="768"><rect width="1024" height="768"/></svg>


<a href="javascript:void(0)" class="add-data action-button">Add data</a>
-->

<script>



    (function poll() {
        setTimeout(function() {
            $.ajax({
                url: "/content",
                type: "GET",
                success: function(data) {

                    if(lastData!=CryptoJS.MD5(data).toString()){
                        //letcontent(data.toString());
                        console.log("update fired");
                        letcontent(data.toString());
                        lastData=CryptoJS.MD5(data).toString();
                    }

                },
                contentType: "text/plain",
                dataType: "text",
                complete: poll,
                timeout: 2000
            })
        }, 5000);
    })();



    var lastData;

    function httpGet()
    {
        var address="/content";
        if (window.XMLHttpRequest)
        {// code for IE7+, Firefox, Chrome, Opera, Safari
            xmlhttp=new XMLHttpRequest();
        }
        else
        {// code for IE6, IE5
            xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange=function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                letcontent(xmlhttp.responseText);
                lastData=CryptoJS.MD5(xmlhttp.responseText);
                return xmlhttp.responseText;
            }
        }
        xmlhttp.open("GET", address,false);
        xmlhttp.send();
    }

    function updata(mycontent){

    }

    function letcontent(mycontent){

        var links = JSON.parse(mycontent);

        /*
        var links = [
            {source: "Microsoft", target: "Amazon", type: "licensing"},
            {source: "Microsoft", target: "HTC", type: "licensing"},
            {source: "Samsung", target: "Apple", type: "suit"},
            {source: "Motorola", target: "Apple", type: "suit"},
            {source: "Nokia", target: "Apple", type: "resolved"},
            {source: "HTC", target: "Apple", type: "suit"},
            {source: "Kodak", target: "Apple", type: "suit"},
            {source: "Microsoft", target: "Barnes & Noble", type: "suit"},
            {source: "Microsoft", target: "Foxconn", type: "suit"},
            {source: "Oracle", target: "Google", type: "suit"},
            {source: "Apple", target: "HTC", type: "suit"},
            {source: "Microsoft", target: "Inventec", type: "suit"},
            {source: "Samsung", target: "Kodak", type: "resolved"},
            {source: "LG", target: "Kodak", type: "resolved"},
            {source: "RIM", target: "Kodak", type: "suit"},
            {source: "Sony", target: "LG", type: "suit"},
            {source: "Kodak", target: "LG", type: "resolved"},
            {source: "Apple", target: "Nokia", type: "resolved"},
            {source: "Qualcomm", target: "Nokia", type: "resolved"},
            {source: "Apple", target: "Motorola", type: "suit"},
            {source: "Microsoft", target: "Motorola", type: "suit"},
            {source: "Motorola", target: "Microsoft", type: "suit"},
            {source: "Huawei", target: "ZTE", type: "suit"},
            {source: "Ericsson", target: "ZTE", type: "suit"},
            {source: "Kodak", target: "Samsung", type: "resolved"},
            {source: "Apple", target: "Samsung", type: "suit"},
            {source: "Kodak", target: "RIM", type: "suit"},
            {source: "Nokia", target: "Qualcomm", type: "suit"}
        ]; */

        var nodes = {};

// Compute the distinct nodes from the links.
        links.forEach(function(link) {
            link.source = nodes[link.source] || (nodes[link.source] = {name: link.source});
            link.target = nodes[link.target] || (nodes[link.target] = {name: link.target});
        });

        var width = 960,
                height = 500;

        var force = d3.layout.force()
                .nodes(d3.values(nodes))
                .links(links)
                .size([width, height])
                .linkDistance(60)
                .charge(-300)
                .on("tick", tick)
                .start();

        var svg;

        svg = d3.select("svg");

        if(svg.toString()==""){
            svg = d3.select("body").append("svg")
                    .attr("width", width)
                    .attr("height", height);
        }else {
            //d3.selectAll("circle").data(force.nodes(),function(d) {return d.name;}).exit().remove();
            //d3.selectAll("text").data(force.nodes(),function(d) {return d.name;}).exit().remove();
            //d3.selectAll("path").data(force.nodes(),function(d) {return d.name;}).exit().remove();
            d3.selectAll("path").remove();
            d3.selectAll("circle").remove();
            d3.selectAll("g").remove();
            d3.selectAll("path").remove();
            d3.selectAll("text").remove();
        }


// Per-type markers, as they don't inherit styles.
        svg.append("defs").selectAll("marker")
                .data(["suit", "licensing", "resolved"])
                .enter().append("marker")
                .attr("id", function(d) { return d; })
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 15)
                .attr("refY", -1.5)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5");

        var path = svg.append("g").selectAll("path")
                .data(force.links())
                .enter().append("path")
                .attr("class", function(d) { return "link " + d.type; })
                .attr("marker-end", function(d) { return "url(#" + d.type + ")"; });

        //console.log(force.nodes());

        var circle1 = svg.append("g").selectAll("circle")
                .data(force.nodes(),
                function(d) {
                    console.log("---->"+JSON.stringify(d, null, 4));
                    return d.name;}
        );

        var circle = circle1
                .enter().append("circle")
                .attr("r", 6)
                .call(force.drag);

        var text = svg.append("g").selectAll("text")
                .data(force.nodes())
                .enter().append("text")
                .attr("x", 8)
                .attr("y", ".31em")
                .text(function(d) { return d.name; });

// Use elliptical arc path segments to doubly-encode directionality.
        function tick() {
            path.attr("d", linkArc);
            circle.attr("transform", transform);
            text.attr("transform", transform);
        }

        function linkArc(d) {
            var dx = d.target.x - d.source.x,
                    dy = d.target.y - d.source.y,
                    dr = Math.sqrt(dx * dx + dy * dy);
            return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
        }

        function transform(d) {
            return "translate(" + d.x + "," + d.y + ")";
        }


        //d3.selectAll("marker").data(nodes).exit().remove();
        //d3.selectAll("path").data(nodes).exit().remove();
        //d3.selectAll("circle").data(nodes,function(d) { return d.name;}).exit().remove();
        //function(d) { console.log(JSON.stringify(d, null, 4));}
        //d3.selectAll("text").data(nodes).exit().remove();

    }

    d3.selectAll(".add-data")
            .on("click", function() {


            });

    httpGet();

</script>

</body>

</html>